services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - SPRING_AUTO_CONFIGURE_EXCLUDE=org.springframework.boot.autoconfigure.security.saml2.Saml2RelyingPartyAutoConfiguration
      - SAML_ENABLED=${SAML_ENABLED:-false}
      - SAML_IDP_METADATA_URI=${SAML_IDP_METADATA_URI:-}
      - SAML_ENTITY_ID=${SAML_ENTITY_ID:-}
      - APP_FRONTEND_BASE_URL=${APP_FRONTEND_BASE_URL:-https://frontend:3000}
    ports:
      - "8080:8080"
    networks:
      - saml-net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_BASE_URL=
      - BACKEND_BASE_URL=${BACKEND_BASE_URL:-http://backend:8080}
      - NEXT_DEV_HTTPS_KEY=${NEXT_DEV_HTTPS_KEY:-./certs/localhost-key.pem}
      - NEXT_DEV_HTTPS_CERT=${NEXT_DEV_HTTPS_CERT:-./certs/localhost-cert.pem}
      - DEV_HOST=0.0.0.0
      - DEV_PORT=3000
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/certs:/app/certs:ro
    command: npm run dev
    depends_on:
      - backend
    networks:
      - saml-net

  proxy:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/certs:/etc/nginx/certs:ro
    ports:
      - "443:443"
    depends_on:
      - frontend
      - backend
    networks:
      - saml-net

networks:
  saml-net: {}
